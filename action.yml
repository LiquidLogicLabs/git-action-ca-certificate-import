name: 'CA Certificate Import'
description: 'Install custom SSL/TLS certificates for build environments'
author: 'LiquidLogicLabs'

branding:
  icon: 'shield'
  color: 'blue'

inputs:
  certificate:
    description: |
      Certificate source: auto-detects file path, URL, or inline content.
      - URL: starts with http:// or https:// (e.g., 'https://pki.company.com/ca.crt')
      - File path: relative or absolute path to certificate file (e.g., 'certs/ca.crt')
      - Inline: contains -----BEGIN CERTIFICATE----- markers (e.g., from secrets)
    required: true
  
  certificateName:
    description: 'Name for the certificate file (auto-generated if not specified)'
    required: false
    default: ''
  
  verbose:
    description: 'Enable verbose debug logging. Also enabled when ACTIONS_STEP_DEBUG=true.'
    required: false
    default: 'false'
  
  generateBuildkit:
    description: 'Generate buildkit.toml configuration file with CA certificate settings'
    required: false
    default: 'false'
  
  buildkitRuntime:
    description: 'Container runtime for BuildKit (e.g., "io.containerd.runc.v2"). Leave empty to omit runtime configuration'
    required: false
    default: ''

  skipCertificateCheck:
    description: 'Skip TLS certificate verification when downloading certificates from URLs'
    required: false
    default: 'false'

outputs:
  certificatePath:
    description: 'Path where the certificate was installed'
    value: ${{ steps.install-cert.outputs.certificatePath }}
  
  certificateName:
    description: 'Name of the installed certificate file'
    value: ${{ steps.install-cert.outputs.certificateName }}
  
  buildkitPath:
    description: 'Path to the generated buildkit.toml file (only set if generate-buildkit is true)'
    value: ${{ steps.install-cert.outputs.buildkitPath }}

runs:
  using: 'composite'
  steps:
    - name: Install certificate
      id: install-cert
      shell: bash
      run: ${{ github.action_path }}/install-certificate.sh
      env:
        INPUT_CERTIFICATE: ${{ inputs.certificate }}
        INPUT_CERTIFICATE_NAME: ${{ inputs.certificateName }}
        INPUT_VERBOSE: ${{ inputs.verbose == 'true' || env.ACTIONS_STEP_DEBUG == 'true' }}
        INPUT_GENERATE_BUILDKIT: ${{ inputs.generateBuildkit }}
        INPUT_BUILDKIT_RUNTIME: ${{ inputs.buildkitRuntime }}
        INPUT_SKIP_CERTIFICATE_CHECK: ${{ inputs.skipCertificateCheck }}

